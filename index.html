<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloopr</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' x='0.1em' font-size='90'%3E%F0%9F%8E%B2%3C/text%3E%3C/svg%3E" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-track {
            height: 4px;
            border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgb(168, 85, 247);
            cursor: pointer;
            margin-top: -6px;
        }
        input[type="range"]::-moz-range-track {
            height: 4px;
            border-radius: 2px;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgb(168, 85, 247);
            cursor: pointer;
            border: none;
        }
        
	.time-display {
    	    font-size: 0.75rem;
    	    color: rgb(148, 163, 184);
	}

        .highlight-pulse { animation: highlightPulse 2s ease-out 1; border-color: rgb(236,72,153) !important; }
        .highlight-pulse-5 { animation: highlightPulse 5s ease-out 1; border-color: rgb(236,72,153) !important; }
        @keyframes highlightPulse {
            0% { box-shadow: 0 0 0 0 rgba(236,72,153,0.95); }
            50% { box-shadow: 0 0 0 12px rgba(236,72,153,0.0); }
            100% { box-shadow: 0 0 0 0 rgba(236,72,153,0.0); }
        }
</style>
<style>
/* Light mode overrides */
body.light-mode {
    background-image: none !important;
    background-color: #f8fafc !important; /* slate-50 */
    color: #0f172a !important; /* slate-900 */
}
.light-mode [class*="text-white"] { color: #0f172a !important; }
.light-mode [class*="bg-slate-900"],
.light-mode [class*="bg-slate-800"],
.light-mode [class*="bg-slate-700"] { background-color: #f1f5f9 !important; } /* slate-100 */
.light-mode [class*="border-slate-700"],
.light-mode [class*="border-purple-500"] { border-color: #cbd5e1 !important; } /* slate-300 */
.light-mode [class*="text-slate-300"] { color: #334155 !important; } /* slate-700 */
.light-mode [class*="text-slate-400"] { color: #475569 !important; } /* slate-600 */
.light-mode [class*="bg-slate-700 hover:bg-slate-600"] { background-color: #e2e8f0 !important; }
.light-mode #active-sounds-bar { background-color: rgba(248,250,252,0.95) !important; }
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
    <div class="container mx-auto px-4 py-8 pb-32">
        <div class="relative mb-4">
            <div class="absolute right-0 top-0 flex items-center gap-2">
                <button onclick="toggleLightMode()" class="px-3 py-2 rounded-full bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-200 text-sm md:text-base" aria-label="Toggle light mode">üåì</button>
                <button onclick="openInfoModal()" class="px-3 py-2 rounded-full bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-200 text-sm md:text-base" aria-label="Info and Help">‚ÑπÔ∏è</button>
            </div>
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">Bloopr</h1>
                <div id="active-session-label" class="mt-1 text-slate-300 text-sm">Session: Default</div>
            </div>
        </div>

        <!-- Favorites Section -->
        <div id="favorites-section" class="flex justify-between items-center mb-4 flex-wrap gap-2">
    <h2 class="text-xl font-semibold flex items-center gap-2">
        <svg class="w-5 h-5 fill-yellow-400 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
        Favorites
    </h2>
        <div class="w-full flex flex-wrap gap-2 p-2 bg-slate-800/40 border border-slate-700 rounded-xl">
        <div class="w-full flex items-center gap-2 mb-1">
            <button onclick="openSessionsModal()" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">Sessions</button>
            <button onclick="exportFavorites()" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-sm">Export</button>
            <button onclick="openImportModal()" class="px-3 py-2 rounded bg-purple-600 hover:bg-purple-700 text-sm">Import</button>
        </div>
        <button onclick="expandAll()" class="flex-1 min-w-[44%] flex items-center justify-center gap-2 px-4 py-2 rounded-full text-sm md:text-base transition-all shadow-sm active:scale-[0.98] bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500">
            <span class="text-base">‚¨áÔ∏è</span>
            <span>Expand</span>
        </button>
        <button onclick="collapseAll()" class="flex-1 min-w-[44%] flex items-center justify-center gap-2 px-4 py-2 rounded-full text-sm md:text-base transition-all shadow-sm active:scale-[0.98] bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500">
            <span class="text-base">‚¨ÜÔ∏è</span>
            <span>Collapse</span>
        </button>
        <button onclick="clearAllFavorites()" class="flex-1 min-w-[44%] flex items-center justify-center gap-2 px-4 py-2 rounded-full text-sm md:text-base transition-all shadow-sm active:scale-[0.98] bg-gradient-to-r from-rose-600 to-pink-600 hover:from-rose-500 hover:to-pink-500">
            <svg class="w-4 h-4 md:w-5 md:h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            <span>Clear</span>
        </button>
        <button onclick="openPresetModal()" class="flex-1 min-w-[44%] flex items-center justify-center gap-2 px-4 py-2 rounded-full text-sm md:text-base transition-all shadow-sm active:scale-[0.98] bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500">
            <span class="text-base">üéõÔ∏è</span>
            <span>Presets</span>
        </button>
            <button onclick="openSearchModal()" class="flex-1 min-w-[44%] flex items-center justify-center gap-2 px-4 py-2 rounded-full text-sm md:text-base transition-all shadow-sm active:scale-[0.98] bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500">
                <span class="text-base">üîé</span>
                <span>Search</span>
            </button>
    </div>
            </div>
            <div id="favorites-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3"></div>
        </div>

<!-- Expandable Categories -->
<div id="categories-container"></div>

        <!-- Sound Grid removed: categories now handle listing -->
    </div>

    <!-- Active Sounds Bar -->
    <div id="active-sounds-bar" class="hidden fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur border-t border-purple-500/30 p-4 shadow-lg">
        <h3 class="text-lg font-semibold mb-3 flex items-center gap-2 justify-between">
            <span class="inline-flex items-center gap-2">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                Active Sounds (<span id="active-count">0</span>)
            </span>
            <div class="flex items-center gap-2">
                <button onclick="toggleActiveBarSize()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm transition-colors" id="activebar-size-btn">Expand</button>
                <button onclick="clearAllActiveSounds()" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors">Clear All</button>
            </div>
        </h3>
        <div id="active-sounds-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-48 overflow-y-auto"></div>
    </div>

    <!-- Preset Modal -->
    <div id="preset-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closePresetModal()"></div>
        <div class="relative mx-auto mt-16 w-11/12 max-w-4xl bg-slate-900 border border-slate-700 rounded-lg shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h3 class="text-lg font-semibold">Choose a Preset</h3>
                <button onclick="closePresetModal()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">Close</button>
            </div>
            <div id="preset-grid" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto flex-1"></div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeSearchModal()"></div>
        <div class="relative mx-auto mt-16 w-11/12 max-w-3xl bg-slate-900 border border-slate-700 rounded-lg shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 class="text-lg font-semibold">Search Sounds</h3>
                <button onclick="closeSearchModal()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">Close</button>
            </div>
            <div class="p-4">
                <input id="search-input" type="text" placeholder="Type to search..." oninput="performSearch(this.value)" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
            <div id="search-results" class="p-2 pb-4 max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Sessions Modal -->
    <div id="sessions-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeSessionsModal()"></div>
        <div class="relative mx-auto mt-16 w-11/12 max-w-3xl bg-slate-900 border border-slate-700 rounded-lg shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 class="text-lg font-semibold">Manage Sessions</h3>
                <button onclick="closeSessionsModal()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">Close</button>
            </div>
            <div class="p-4 flex items-center gap-2">
                <input id="session-name-input" type="text" placeholder="New session name" class="flex-1 px-3 py-2 bg-slate-800 border border-slate-700 rounded focus:outline-none focus:ring-2 focus:ring-purple-500" />
                <button onclick="createSessionFromModal()" class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-sm">Create</button>
            </div>
            <div id="session-create-error" class="px-4 text-rose-400 text-sm hidden"></div>
            <div id="sessions-list" class="px-4 pb-4 max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeConfirmModal()"></div>
        <div class="relative mx-auto mt-24 w-11/12 max-w-md bg-slate-900 border border-slate-700 rounded-lg shadow-2xl">
            <div class="p-4 border-b border-slate-700">
                <h3 id="confirm-title" class="text-lg font-semibold">Confirm</h3>
            </div>
            <div id="confirm-message" class="p-4 text-slate-300">Are you sure?</div>
            <div class="p-4 flex justify-end gap-2 border-t border-slate-700">
                <button onclick="closeConfirmModal()" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">Cancel</button>
                <button onclick="confirmModalProceed()" class="px-3 py-2 rounded bg-red-600 hover:bg-red-700 text-sm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Rename Session Modal -->
    <div id="rename-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeRenameModal()"></div>
        <div class="relative mx-auto mt-24 w-11/12 max-w-md bg-slate-900 border border-slate-700 rounded-lg shadow-2xl">
            <div class="p-4 border-b border-slate-700">
                <h3 class="text-lg font-semibold">Rename Session</h3>
            </div>
            <div class="p-4">
                <input id="rename-input" type="text" placeholder="Session name" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded focus:outline-none focus:ring-2 focus:ring-purple-500" />
                <div id="rename-error" class="mt-2 text-rose-400 text-sm hidden"></div>
            </div>
            <div class="p-4 flex justify-end gap-2 border-t border-slate-700">
                <button onclick="closeRenameModal()" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">Cancel</button>
                <button onclick="saveRenameSession()" class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-sm">Save</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeInfoModal()"></div>
        <div class="relative mx-auto mt-12 w-11/12 max-w-3xl bg-slate-900 border border-slate-700 rounded-lg shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 class="text-lg font-semibold">Info & Help</h3>
                <button onclick="closeInfoModal()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">Close</button>
            </div>
            <div class="p-4 space-y-4 text-sm md:text-base">
                <div>
                    <h4 class="font-semibold mb-1">Using Bloopr</h4>
                    <ul class="list-disc pl-5 text-slate-300">
                        <li>Tap a sound to Play/Pause. Use Loop to repeat.</li>
                        <li>Priority ducks other sounds while it plays.</li>
                        <li>Active bar shows volume, loop, pause, stop for each playing sound.</li>
                        <li>Search finds sounds and jumps to them.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-1">Favorites, Sessions, Presets</h4>
                    <ul class="list-disc pl-5 text-slate-300">
                        <li>Favorites are saved per Session. Use Sessions to create/switch/rename.</li>
                        <li>Presets quickly load curated sets.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-1">Import/Export</h4>
                    <ul class="list-disc pl-5 text-slate-300">
                        <li>Export downloads a JSON of sound names.</li>
                        <li>Import accepts a JSON of names; unknown names are skipped with a note.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-1">Mobile tips</h4>
                    <ul class="list-disc pl-5 text-slate-300">
                        <li>Use Expand on the Active bar to see more at once.</li>
                        <li>Buttons are touch-friendly; rotate for wider layouts.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="notice-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeNotice()"></div>
        <div class="relative mx-auto mt-24 w-11/12 max-w-md bg-slate-900 border border-slate-700 rounded-lg shadow-2xl">
            <div class="p-4 border-b border-slate-700">
                <h3 class="text-lg font-semibold">Notice</h3>
            </div>
            <div id="notice-message" class="p-4 text-slate-300">Done.</div>
            <div class="p-4 flex justify-end gap-2 border-t border-slate-700">
                <button onclick="closeNotice()" class="px-3 py-2 rounded bg-slate-700 hover:bg-slate-600 text-sm">OK</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeIOModal()"></div>
        <div class="relative mx-auto mt-16 w-11/12 max-w-md bg-slate-900 border border-slate-700 rounded-lg shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-slate-700">
                <h3 class="text-lg font-semibold" id="io-title">Import session</h3>
                <button onclick="closeIOModal()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded">Close</button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <h4 class="font-semibold mb-2">Import session</h4>
                    <input id="import-file" type="file" accept="application/json" class="block w-full text-sm text-slate-300" />
                    <div id="import-error" class="mt-2 text-rose-400 text-sm hidden"></div>
                    <div class="mt-3 flex justify-end">
                        <button onclick="importFavoritesFromInput()" class="px-3 py-2 rounded bg-purple-600 hover:bg-purple-700 text-sm">Import</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Icons as SVG strings
        const icons = {
            play: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',
            pause: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',
            square: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',
            repeat: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>',
            repeat1: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path><path d="M11 10h1v4"></path></svg>',
            volume: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>',
            star: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
            starFilled: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
            x: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'
        };

        // Sound Library Configuration - EDIT THIS TO ADD/REMOVE SOUNDS
        const soundLibrary = {
    'Tavern & Inn': [
        { id: 'tavern-crowd', name: 'Tavern Crowd', url: '/sounds/tavern/crowd.mp3', icon: 'üç∫' },
        { id: 'tavern-music', name: 'Lute Music', url: '/sounds/tavern/lute.mp3', icon: 'üéµ' },
        { id: 'fireplace', name: 'Fireplace Crackle', url: '/sounds/tavern/fireplace.wav', icon: 'üî•' },
        { id: 'pouring-ale', name: 'Pouring Ale', url: '/sounds/tavern/ale.mp3', icon: 'üçª' },
        { id: 'dice-roll', name: 'Dice on Table', url: '/sounds/tavern/dice.mp3', icon: 'üé≤' },
        { id: 'chair-scrape', name: 'Chair Scraping', url: '/sounds/tavern/chair.mp3', icon: 'ü™ë' },
        { id: 'bard-song', name: 'Bard Song', url: '/sounds/tavern/bard.mp3', icon: 'üé§' },
        { id: 'murmur-low', name: 'Low Murmurs', url: '/sounds/tavern/murmur.mp3', icon: 'üó£Ô∏è' },
        { id: 'mug-clink', name: 'Mugs Clinking', url: '/sounds/tavern/mugs.mp3', icon: 'üç∫' },
        { id: 'fiddle-tune', name: 'Fiddle Tune', url: '/sounds/tavern/fiddle.mp3', icon: 'üéª' }
    ],
    
    'Combat & Battle': [
        { id: 'sword-clash', name: 'Sword Clash', url: '/sounds/combat/sword-clash.mp3', icon: '‚öîÔ∏è' },
        { id: 'sword-swing', name: 'Sword Swing', url: '/sounds/combat/swing.mp3', icon: 'üó°Ô∏è' },
        { id: 'arrow-shot', name: 'Arrow Release', url: '/sounds/combat/arrow.mp3', icon: 'üèπ' },
        { id: 'shield-block', name: 'Shield Block', url: '/sounds/combat/shield.mp3', icon: 'üõ°Ô∏è' },
        { id: 'battle-cry', name: 'Battle Cry', url: '/sounds/combat/cry.mp3', icon: 'üò§' },
        { id: 'armor-clank', name: 'Armor Clank', url: '/sounds/combat/armor.mp3', icon: 'ü¶æ' },
        { id: 'crossbow', name: 'Crossbow Shot', url: '/sounds/combat/crossbow.mp3', icon: 'üéØ' },
        { id: 'punch', name: 'Punch Impact', url: '/sounds/combat/punch.mp3', icon: 'üëä' },
        { id: 'spell-impact', name: 'Spell Impact', url: '/sounds/combat/spell-impact.mp3', icon: '‚ú®' },
        { id: 'war-drum', name: 'War Drums', url: '/sounds/combat/drums.mp3', icon: 'ü•Å' }
    ],
    
    'Magic & Spells': [
        { id: 'fireball', name: 'Fireball', url: '/sounds/magic/fireball.mp3', icon: 'üî•' },
        { id: 'ice-spell', name: 'Ice Spell', url: '/sounds/magic/ice.mp3', icon: '‚ùÑÔ∏è' },
        { id: 'lightning', name: 'Lightning Bolt', url: '/sounds/magic/lightning.mp3', icon: '‚ö°' },
        { id: 'heal-spell', name: 'Healing Spell', url: '/sounds/magic/heal.mp3', icon: '‚ú®' },
        { id: 'teleport', name: 'Teleport', url: '/sounds/magic/teleport.mp3', icon: 'üí´' },
        { id: 'magic-shield', name: 'Magic Shield', url: '/sounds/magic/shield.mp3', icon: 'üîÆ' },
        { id: 'enchant', name: 'Enchantment', url: '/sounds/magic/enchant.mp3', icon: '‚ú¥Ô∏è' },
        { id: 'dark-magic', name: 'Dark Magic', url: '/sounds/magic/dark.mp3', icon: 'üåë' },
        { id: 'chaos-surge', name: 'Chaos Surge', url: '/sounds/magic/chaos.mp3', icon: 'üåÄ' },
        { id: 'whisper-ritual', name: 'Whispered Ritual', url: '/sounds/magic/ritual-whisper.mp3', icon: 'üóùÔ∏è' }
    ],
    
    'Dungeon & Cave': [
        { id: 'dungeon-ambience', name: 'Dungeon Ambience', url: '/sounds/dungeon/ambience.mp3', icon: 'üè∞' },
        { id: 'water-drip', name: 'Water Dripping', url: '/sounds/dungeon/drip.mp3', icon: 'üíß' },
        { id: 'chains', name: 'Rattling Chains', url: '/sounds/dungeon/chains.mp3', icon: '‚õìÔ∏è' },
        { id: 'stone-door', name: 'Stone Door', url: '/sounds/dungeon/stone-door.mp3', icon: 'üö™' },
        { id: 'torch', name: 'Torch Burning', url: '/sounds/dungeon/torch.mp3', icon: 'üî¶' },
        { id: 'echo-steps', name: 'Echoing Steps', url: '/sounds/dungeon/echo.mp3', icon: 'üë£' },
        { id: 'trap-trigger', name: 'Trap Triggered', url: '/sounds/dungeon/trap.mp3', icon: '‚ö†Ô∏è' },
        { id: 'cave-in', name: 'Cave-In Rumble', url: '/sounds/dungeon/cavein.mp3', icon: 'ü™®' },
        { id: 'door-iron', name: 'Iron Gate', url: '/sounds/dungeon/iron-gate.mp3', icon: 'üóùÔ∏è' },
        { id: 'torch-extinguish', name: 'Torch Extinguish', url: '/sounds/dungeon/torch-out.mp3', icon: 'üïØÔ∏è' }
    ],
    
    'Forest & Nature': [
        { id: 'forest-ambience', name: 'Forest Ambience', url: '/sounds/forest/ambience.mp3', icon: 'üå≤' },
        { id: 'birds', name: 'Bird Calls', url: '/sounds/forest/birds.mp3', icon: 'üê¶' },
        { id: 'stream', name: 'Babbling Stream', url: '/sounds/forest/stream.mp3', icon: 'üåä' },
        { id: 'wind-leaves', name: 'Wind in Leaves', url: '/sounds/forest/wind.mp3', icon: 'üçÉ' },
        { id: 'owl', name: 'Owl Hoot', url: '/sounds/forest/owl.mp3', icon: 'ü¶â' },
        { id: 'rustling', name: 'Bush Rustling', url: '/sounds/forest/rustle.mp3', icon: 'üåø' },
        { id: 'crickets', name: 'Night Crickets', url: '/sounds/forest/crickets.mp3', icon: 'ü¶ó' },
        { id: 'squirrel', name: 'Squirrel Chatter', url: '/sounds/forest/squirrel.mp3', icon: 'üêøÔ∏è' },
        { id: 'bees', name: 'Bees Nearby', url: '/sounds/forest/bees.mp3', icon: 'üêù' }
    ],
    
    'Creatures & Monsters': [
        { id: 'dragon-roar', name: 'Dragon Roar', url: '/sounds/creatures/dragon.mp3', icon: 'üêâ' },
        { id: 'wolf-howl', name: 'Wolf Howl', url: '/sounds/creatures/wolf.mp3', icon: 'üê∫' },
        { id: 'zombie', name: 'Zombie Groan', url: '/sounds/creatures/zombie.mp3', icon: 'üßü' },
        { id: 'skeleton', name: 'Skeleton Rattle', url: '/sounds/creatures/skeleton.mp3', icon: 'üíÄ' },
        { id: 'ghost', name: 'Ghost Wail', url: '/sounds/creatures/ghost.mp3', icon: 'üëª' },
        { id: 'goblin', name: 'Goblin Screech', url: '/sounds/creatures/goblin.mp3', icon: 'üë∫' },
        { id: 'troll', name: 'Troll Growl', url: '/sounds/creatures/troll.mp3', icon: 'üëπ' },
        { id: 'spider', name: 'Giant Spider', url: '/sounds/creatures/spider.mp3', icon: 'üï∑Ô∏è' },
        { id: 'bat-swarm', name: 'Bat Swarm', url: '/sounds/creatures/bats.mp3', icon: 'ü¶á' },
        { id: 'snake-hiss', name: 'Snake Hiss', url: '/sounds/creatures/snake.mp3', icon: 'üêç' },
        { id: 'rat-squeak', name: 'Rat Squeaks', url: '/sounds/creatures/rats.mp3', icon: 'üêÄ' },
        { id: 'slime', name: 'Slime Squish', url: '/sounds/creatures/slime.mp3', icon: 'ü´ß' }
    ],
    
    'Weather & Elements': [
        { id: 'rain-light', name: 'Light Rain', url: '/sounds/weather/light-rain.mp3', icon: 'üåßÔ∏è' },
        { id: 'rain-heavy', name: 'Heavy Rainstorm', url: '/sounds/weather/heavy-rain.mp3', icon: '‚õàÔ∏è' },
        { id: 'thunder', name: 'Thunder Clap', url: '/sounds/weather/thunder.mp3', icon: '‚ö°' },
        { id: 'wind-gentle', name: 'Gentle Breeze', url: '/sounds/weather/breeze.mp3', icon: 'üí®' },
        { id: 'wind-storm', name: 'Windstorm', url: '/sounds/weather/windstorm.mp3', icon: 'üå™Ô∏è' },
        { id: 'snow', name: 'Snowstorm', url: '/sounds/weather/snow.mp3', icon: '‚ùÑÔ∏è' },
        { id: 'fog', name: 'Eerie Fog', url: '/sounds/weather/fog.mp3', icon: 'üå´Ô∏è' },
        { id: 'hail', name: 'Hail', url: '/sounds/weather/hail.mp3', icon: 'üßä' }
    ],
    
    'City & Town': [
        { id: 'marketplace', name: 'Marketplace', url: '/sounds/city/market.mp3', icon: 'üè™' },
        { id: 'town-square', name: 'Town Square', url: '/sounds/city/square.mp3', icon: 'üèõÔ∏è' },
        { id: 'bell-tower', name: 'Church Bells', url: '/sounds/city/bells.mp3', icon: 'üîî' },
        { id: 'harbor', name: 'Harbor Docks', url: '/sounds/city/harbor.mp3', icon: '‚öì' },
        { id: 'blacksmith', name: 'Blacksmith', url: '/sounds/city/blacksmith.mp3', icon: '‚öíÔ∏è' },
        { id: 'crowd', name: 'City Crowd', url: '/sounds/city/crowd.mp3', icon: 'üë•' },
        { id: 'horse-cart', name: 'Horse Cart', url: '/sounds/city/cart.mp3', icon: 'üê¥' },
        { id: 'guard-halt', name: 'Guard: Halt!', url: '/sounds/city/guard.mp3', icon: 'üõ°Ô∏è' },
        { id: 'town-crier', name: 'Town Crier', url: '/sounds/city/crier.mp3', icon: 'üì£' }
    ],
    
    'Ocean & Sea': [
        { id: 'ocean-waves', name: 'Ocean Waves', url: '/sounds/ocean/waves.mp3', icon: 'üåä' },
        { id: 'seagulls', name: 'Seagulls', url: '/sounds/ocean/seagulls.mp3', icon: 'ü¶Ö' },
        { id: 'ship-creak', name: 'Ship Creaking', url: '/sounds/ocean/ship.mp3', icon: '‚õµ' },
        { id: 'underwater', name: 'Underwater', url: '/sounds/ocean/underwater.mp3', icon: 'üåÄ' },
        { id: 'whale', name: 'Whale Song', url: '/sounds/ocean/whale.mp3', icon: 'üêã' },
        { id: 'storm-at-sea', name: 'Storm at Sea', url: '/sounds/ocean/storm.mp3', icon: 'üåä' },
        { id: 'rigging', name: 'Rigging and Ropes', url: '/sounds/ocean/rigging.mp3', icon: 'ü™¢' }
    ],
    
    'Items & Objects': [
        { id: 'coins', name: 'Coins Jingling', url: '/sounds/items/coins.mp3', icon: 'üí∞' },
        { id: 'chest-open', name: 'Chest Opening', url: '/sounds/items/chest.mp3', icon: 'üì¶' },
        { id: 'key-turn', name: 'Key in Lock', url: '/sounds/items/key.mp3', icon: 'üîë' },
        { id: 'potion-drink', name: 'Drinking Potion', url: '/sounds/items/potion.mp3', icon: 'üß™' },
        { id: 'page-turn', name: 'Page Turning', url: '/sounds/items/page.mp3', icon: 'üìñ' },
        { id: 'quill-write', name: 'Quill Writing', url: '/sounds/items/quill.mp3', icon: 'ü™∂' },
        { id: 'glass-break', name: 'Glass Breaking', url: '/sounds/items/glass.mp3', icon: 'üí•' },
        { id: 'bag-drop', name: 'Heavy Bag Drop', url: '/sounds/items/bag.mp3', icon: 'üéí' },
        { id: 'lock-click', name: 'Lock Click', url: '/sounds/items/lock-click.mp3', icon: 'üóùÔ∏è' },
        { id: 'ink-scratch', name: 'Ink Scratch', url: '/sounds/items/ink.mp3', icon: '‚úíÔ∏è' }
    ],
    
    'Doors & Movement': [
        { id: 'door-creak', name: 'Door Creaking', url: '/sounds/doors/creak.mp3', icon: 'üö™' },
        { id: 'door-slam', name: 'Door Slam', url: '/sounds/doors/slam.mp3', icon: 'üí•' },
        { id: 'footsteps-wood', name: 'Footsteps on Wood', url: '/sounds/doors/wood-steps.mp3', icon: 'üë£' },
        { id: 'footsteps-stone', name: 'Footsteps on Stone', url: '/sounds/doors/stone-steps.mp3', icon: 'ü¶∂' },
        { id: 'running', name: 'Running Footsteps', url: '/sounds/doors/running.mp3', icon: 'üèÉ' },
        { id: 'stairs', name: 'Climbing Stairs', url: '/sounds/doors/stairs.mp3', icon: 'ü™ú' },
        { id: 'stealth-steps', name: 'Stealthy Steps', url: '/sounds/doors/stealth.mp3', icon: 'ü´•' }
    ],
    
    'Horror & Suspense': [
        { id: 'heartbeat', name: 'Heartbeat', url: '/sounds/horror/heartbeat.mp3', icon: '‚ù§Ô∏è' },
        { id: 'whispers', name: 'Eerie Whispers', url: '/sounds/horror/whispers.mp3', icon: 'üë§' },
        { id: 'scream', name: 'Scream', url: '/sounds/horror/scream.mp3', icon: 'üò±' },
        { id: 'creepy-laugh', name: 'Creepy Laugh', url: '/sounds/horror/laugh.mp3', icon: 'üòà' },
        { id: 'clock-ticking', name: 'Clock Ticking', url: '/sounds/horror/clock.mp3', icon: '‚è∞' },
        { id: 'music-box', name: 'Creepy Music Box', url: '/sounds/horror/music-box.mp3', icon: 'üéµ' },
        { id: 'breathing', name: 'Heavy Breathing', url: '/sounds/horror/breathing.mp3', icon: 'üòÆ‚Äçüí®' },
        { id: 'distant-scream', name: 'Distant Scream', url: '/sounds/horror/distant-scream.mp3', icon: 'üó£Ô∏è' },
        { id: 'light-flicker', name: 'Light Flicker', url: '/sounds/horror/flicker.mp3', icon: 'üí°' },
        { id: 'door-rattle', name: 'Door Rattle', url: '/sounds/horror/door-rattle.mp3', icon: 'üö™' }
    ],
    
    'Sci-Fi & Futuristic': [
        { id: 'laser-shot', name: 'Laser Shot', url: '/sounds/scifi/laser.mp3', icon: 'üî´' },
        { id: 'spaceship', name: 'Spaceship Hum', url: '/sounds/scifi/ship.mp3', icon: 'üöÄ' },
        { id: 'robot', name: 'Robot Beeps', url: '/sounds/scifi/robot.mp3', icon: 'ü§ñ' },
        { id: 'alarm', name: 'Red Alert', url: '/sounds/scifi/alarm.mp3', icon: 'üö®' },
        { id: 'teleporter', name: 'Teleporter', url: '/sounds/scifi/teleport.mp3', icon: '‚ú®' },
        { id: 'computer', name: 'Computer Beeps', url: '/sounds/scifi/computer.mp3', icon: 'üíª' },
    ],
    
    'Victory & Defeat': [
        { id: 'victory-fanfare', name: 'Victory Fanfare', url: '/sounds/victory/fanfare.mp3', icon: 'üé∫' },
        { id: 'level-up', name: 'Level Up', url: '/sounds/victory/levelup.mp3', icon: '‚¨ÜÔ∏è' },
        { id: 'achievement', name: 'Achievement', url: '/sounds/victory/achievement.mp3', icon: 'üèÜ' },
        { id: 'defeat', name: 'Defeat', url: '/sounds/victory/defeat.mp3', icon: 'üíÄ' },
        { id: 'cheer', name: 'Crowd Cheering', url: '/sounds/victory/cheer.mp3', icon: 'üéâ' },
        { id: 'slow-clap', name: 'Slow Clap', url: '/sounds/victory/slowclap.mp3', icon: 'üëè' }
    ],
    
    'Mountains & Highlands': [
        { id: 'cold-wind', name: 'Cold Mountain Wind', url: '/sounds/mountains/wind.mp3', icon: 'üå¨Ô∏è' },
        { id: 'eagle-cry', name: 'Eagle Cry', url: '/sounds/mountains/eagle.mp3', icon: 'ü¶Ö' },
        { id: 'rockfall', name: 'Distant Rockfall', url: '/sounds/mountains/rockfall.mp3', icon: 'ü™®' },
        { id: 'mountain-stream', name: 'Mountain Stream', url: '/sounds/mountains/stream.mp3', icon: 'üíß' }
    ],
    
    'Desert & Wasteland': [
        { id: 'desert-wind', name: 'Desert Wind', url: '/sounds/desert/wind.mp3', icon: 'üå™Ô∏è' },
        { id: 'sand-steps', name: 'Footsteps in Sand', url: '/sounds/desert/steps.mp3', icon: 'üë£' },
        { id: 'scorpion', name: 'Scorpion Skitter', url: '/sounds/desert/scorpion.mp3', icon: 'ü¶Ç' },
        { id: 'mirage-tone', name: 'Mirage Tone', url: '/sounds/desert/mirage.mp3', icon: '‚ô®Ô∏è' }
    ],

    'Arctic & Tundra': [
        { id: 'blizzard', name: 'Blizzard', url: '/sounds/arctic/blizzard.mp3', icon: 'üå®Ô∏è' },
        { id: 'ice-crack', name: 'Cracking Ice', url: '/sounds/arctic/ice-crack.mp3', icon: 'üßä' },
        { id: 'polar-wind', name: 'Polar Wind', url: '/sounds/arctic/wind.mp3', icon: 'üí®' }
    ],

    'Jungle & Savannah': [
        { id: 'jungle-ambience', name: 'Jungle Ambience', url: '/sounds/jungle/ambience.mp3', icon: 'üå¥' },
        { id: 'monkeys', name: 'Monkey Calls', url: '/sounds/jungle/monkeys.mp3', icon: 'üêí' },
        { id: 'big-cat', name: 'Big Cat Growl', url: '/sounds/jungle/cat.mp3', icon: 'üêÜ' },
        { id: 'insects', name: 'Insect Swarm', url: '/sounds/jungle/insects.mp3', icon: 'üêú' }
    ],

    'Temple & Ritual': [
        { id: 'chanting', name: 'Monk Chanting', url: '/sounds/temple/chant.mp3', icon: 'üõï' },
        { id: 'gong', name: 'Gong Hit', url: '/sounds/temple/gong.mp3', icon: 'ü•Å' },
        { id: 'bells', name: 'Ritual Bells', url: '/sounds/temple/bells.mp3', icon: 'üîî' }
    ],

    'Library & Study': [
        { id: 'page-turn-soft', name: 'Soft Page Turns', url: '/sounds/library/pages.mp3', icon: 'üìñ' },
        { id: 'quill-scratch', name: 'Quill Scratch', url: '/sounds/library/quill.mp3', icon: '‚úíÔ∏è' },
        { id: 'quiet-ambience', name: 'Quiet Room', url: '/sounds/library/quiet.mp3', icon: 'ü§´' }
    ],

    'Workshop & Crafting': [
        { id: 'hammer-anvil', name: 'Hammer on Anvil', url: '/sounds/workshop/anvil.mp3', icon: '‚öíÔ∏è' },
        { id: 'saw-wood', name: 'Sawing Wood', url: '/sounds/workshop/saw.mp3', icon: 'ü™ö' },
        { id: 'forge-fire', name: 'Forge Fire', url: '/sounds/workshop/forge.mp3', icon: 'üî•' }
    ],

    'Festival & Celebration': [
        { id: 'fireworks', name: 'Fireworks', url: '/sounds/festival/fireworks.mp3', icon: 'üéÜ' },
        { id: 'laughter', name: 'Laughter', url: '/sounds/festival/laughter.mp3', icon: 'üòÇ' },
        { id: 'music-dance', name: 'Dance Music', url: '/sounds/festival/dance.mp3', icon: 'üíÉ' }
    ],

    'Stealth & Espionage': [
        { id: 'soft-steps', name: 'Soft Footsteps', url: '/sounds/stealth/steps.mp3', icon: 'ü´•' },
        { id: 'door-pick', name: 'Lockpicking', url: '/sounds/stealth/lockpick.mp3', icon: 'üóùÔ∏è' },
        { id: 'whispered-orders', name: 'Whispered Orders', url: '/sounds/stealth/orders.mp3', icon: 'ü§´' }
    ],

    'Vehicles & Travel': [
        { id: 'horse-gallop', name: 'Horse Gallop', url: '/sounds/travel/horse.mp3', icon: 'üêé' },
        { id: 'wagon', name: 'Wagon Rattle', url: '/sounds/travel/wagon.mp3', icon: 'üõû' },
        { id: 'port-tavern', name: 'Port Tavern', url: '/sounds/travel/port-tavern.mp3', icon: 'üçª' }
    ],
};

const categoryIcons = {
    'Tavern & Inn': 'üç∫',
    'Combat & Battle': '‚öîÔ∏è',
    'Magic & Spells': '‚ú®',
    'Dungeon & Cave': 'üè∞',
    'Forest & Nature': 'üå≤',
    'Creatures & Monsters': 'üêâ',
    'Weather & Elements': 'üåßÔ∏è',
    'City & Town': 'üèõÔ∏è',
    'Ocean & Sea': 'üåä',
    'Items & Objects': 'üí∞',
    'Doors & Movement': 'üö™',
    'Horror & Suspense': 'üò±',
    'Sci-Fi & Futuristic': 'üöÄ',
    'Victory & Defeat': 'üèÜ',
    'Mountains & Highlands': '‚õ∞Ô∏è',
    'Desert & Wasteland': 'üèúÔ∏è',
    'Arctic & Tundra': 'üßä',
    'Jungle & Savannah': 'üå¥',
    'Temple & Ritual': 'üõï',
    'Library & Study': 'üìö',
    'Workshop & Crafting': 'üõ†Ô∏è',
    'Festival & Celebration': 'üéä',
    'Stealth & Espionage': 'üïµÔ∏è',
    'Vehicles & Travel': 'üõû'
};

        // State Management
        let activeSounds = {};
let audioElements = {};
let sessions = JSON.parse(localStorage.getItem('soundboard-sessions') || '[]');
let currentSessionId = JSON.parse(localStorage.getItem('soundboard-currentSessionId') || 'null');
function ensureDefaultSession() {
    if (!Array.isArray(sessions) || sessions.length === 0) {
        const def = { id: 'default', name: 'Default' };
        sessions = [def];
        localStorage.setItem('soundboard-sessions', JSON.stringify(sessions));
        localStorage.setItem('soundboard-currentSessionId', JSON.stringify(def.id));
        currentSessionId = def.id;
        // Migrate old favorites key if present
        const oldFav = localStorage.getItem('soundboard-favorites');
        if (oldFav) {
            localStorage.setItem(`soundboard-favorites-${def.id}`, oldFav);
            localStorage.removeItem('soundboard-favorites');
        }
    }
    if (!currentSessionId || !sessions.find(s => s.id === currentSessionId)) {
        currentSessionId = sessions[0].id;
        localStorage.setItem('soundboard-currentSessionId', JSON.stringify(currentSessionId));
    }
}
ensureDefaultSession();
function getFavoritesKey() { return `soundboard-favorites-${currentSessionId}`; }
function loadFavorites() {
    try { return JSON.parse(localStorage.getItem(getFavoritesKey()) || '[]'); } catch { return []; }
}
function persistFavorites() {
    localStorage.setItem(getFavoritesKey(), JSON.stringify(favorites));
}
let favorites = loadFavorites();
let expandedCategories = JSON.parse(localStorage.getItem('soundboard-expanded') || '["Tavern & Inn"]'); // First category expanded by default
let activeTab = JSON.parse(localStorage.getItem('soundboard-activeTab') || 'null') || Object.keys(soundLibrary)[0];
const DUCK_FACTOR = 0.3;
let activeBarExpanded = JSON.parse(localStorage.getItem('soundboard-activeBarExpanded') || 'false');
let lightMode = JSON.parse(localStorage.getItem('soundboard-lightMode') || 'false');

// Preset definitions: curated lists of sound ids
const presets = {
    'Horror': {
        icon: 'üò±',
        description: 'Eerie ambience, whispers, thunder and unsettling tones.',
        ids: ['heartbeat','whispers','scream','creepy-laugh','clock-ticking','music-box','fog','chains','bat-swarm','ghost','thunder','rain-heavy']
    },
    'Dungeon Crawl': {
        icon: 'üè∞',
        description: 'Dark caverns, chains, traps, and lurking creatures.',
        ids: ['dungeon-ambience','water-drip','chains','stone-door','torch','echo-steps','trap-trigger','skeleton','zombie','spider']
    },
    'Tavern Night': {
        icon: 'üç∫',
        description: 'Warm crowd, lute music, fireplace and ale flowing.',
        ids: ['tavern-crowd','tavern-music','fireplace','pouring-ale','dice-roll','chair-scrape']
    },
    'Stormy Sea': {
        icon: 'üåä',
        description: 'Crashing waves, storms, gulls and creaking ships.',
        ids: ['ocean-waves','storm-at-sea','seagulls','ship-creak','wind-storm','thunder']
    },
    'Sci-Fi Ops': {
        icon: 'üöÄ',
        description: 'Starship hums, alerts, lasers and teleports.',
        ids: ['spaceship','computer','alarm','laser-shot','robot','teleporter']
    },
    'Night Cage': {
        icon: 'üïØÔ∏è',
        description: 'Claustrophobic darkness, whispers and echoing steps.',
        ids: ['dungeon-ambience','echo-steps','chains','door-creak','whispers','breathing','light-flicker','fog','trap-trigger']
    },
    'Nyctophobia': {
        icon: 'üåë',
        description: 'Stalking in the dark: breath, wind, distant screams.',
        ids: ['breathing','whispers','distant-scream','soft-steps','wind-storm','owl','fog','door-creak','heartbeat']
    },
    'Everdell': {
        icon: 'üå≥',
        description: 'Cozy woodland life and gentle town bustle.',
        ids: ['forest-ambience','birds','stream','wind-leaves','owl','marketplace','blacksmith','quill-write','page-turn','laughter','music-dance']
    },
    'Gloomhaven': {
        icon: 'üó°Ô∏è',
        description: 'Dungeon crawl with monsters, traps and battle.',
        ids: ['dungeon-ambience','echo-steps','trap-trigger','skeleton','zombie','troll','goblin','spell-impact','sword-clash','war-drum','door-iron']
    },
    'Phantom Ink': {
        icon: 'üñãÔ∏è',
        description: 'Whispers, writing, and eerie quiet.',
        ids: ['quiet-ambience','whispers','ink-scratch','quill-scratch','page-turn-soft','music-box']
    },
    'Ring of Chaos': {
        icon: 'üåÄ',
        description: 'Chaotic magic and unstable energies.',
        ids: ['chaos-surge','dark-magic','lightning','spell-impact','whisper-ritual','war-drum']
    },
    'Stormy Night': {
        icon: '‚õàÔ∏è',
        description: 'Rain, thunder and occasional creaks inside.',
        ids: ['rain-heavy','thunder','wind-storm','door-creak','clock-ticking','light-flicker']
    },
    'Ocean Voyage': {
        icon: '‚õµ',
        description: 'Open sea with waves, gulls and rigging.',
        ids: ['ocean-waves','seagulls','ship-creak','rigging','storm-at-sea']
    }
};

function toggleCategory(category) {
    const index = expandedCategories.indexOf(category);
    if (index >= 0) {
        expandedCategories.splice(index, 1);
    } else {
        expandedCategories.push(category);
    }
    localStorage.setItem('soundboard-expanded', JSON.stringify(expandedCategories));
    render();
}

function findSoundById(soundId) {
    for (const [category, sounds] of Object.entries(soundLibrary)) {
        const sound = sounds.find(s => s.id === soundId);
        if (sound) {
            return { sound, category };
        }
    }
    return null;
}

function findSoundByName(soundName) {
    const target = String(soundName || '').toLowerCase();
    for (const [category, sounds] of Object.entries(soundLibrary)) {
        const sound = sounds.find(s => String(s.name).toLowerCase() === target);
        if (sound) return { sound, category };
    }
    return null;
}

function openSearchModal() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const results = document.getElementById('search-results');
    results.innerHTML = '';
    modal.classList.remove('hidden');
    setTimeout(() => input && input.focus(), 0);
}

function closeSearchModal() {
    const modal = document.getElementById('search-modal');
    modal.classList.add('hidden');
    const input = document.getElementById('search-input');
    const results = document.getElementById('search-results');
    if (input) input.value = '';
    if (results) results.innerHTML = '';
}

function performSearch(query) {
    const q = (query || '').trim().toLowerCase();
    const resultsEl = document.getElementById('search-results');
    if (!q) { resultsEl.innerHTML = ''; return; }
    const matches = [];
    for (const [category, sounds] of Object.entries(soundLibrary)) {
        for (const sound of sounds) {
            const hay = `${sound.name} ${sound.id} ${category}`.toLowerCase();
            if (hay.includes(q)) {
                matches.push({ category, sound });
            }
        }
    }
    const html = matches.map(({ category, sound }) => `
        <button class="w-full text-left px-3 py-2 rounded hover:bg-slate-800/70 border-b border-slate-800 flex items-center gap-3" onclick="goToSound('${sound.id}', '${category}')">
            <span class="text-xl">${sound.icon}</span>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-medium truncate">${sound.name}</div>
                <div class="text-xs text-slate-400 truncate">${category} ‚Ä¢ ${getTagsDisplay(sound.name, category)}</div>
            </div>
        </button>
    `).join('');
    const safeQ = sanitizeText(q);
    resultsEl.innerHTML = html || `<div class="px-3 py-2 text-slate-400">No results for "${safeQ}"</div>`;
}

function goToSound(soundId, category) {
    // Ensure category expanded
    if (!expandedCategories.includes(category)) {
        expandedCategories.push(category);
        localStorage.setItem('soundboard-expanded', JSON.stringify(expandedCategories));
    }
    render();
    // After render, scroll and highlight
    setTimeout(() => {
        const el = document.getElementById(`card-${soundId}`);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.classList.add('highlight-pulse-5');
            setTimeout(() => el.classList.remove('highlight-pulse-5'), 5200);
        }
    }, 50);
    closeSearchModal();
}

function applyPreset(presetName) {
    const preset = presets[presetName];
    const ids = preset ? preset.ids : [];
    const newFavorites = [];
    const categoriesToExpand = new Set();
    ids.forEach(id => {
        const found = findSoundById(id);
        if (found) {
            const { sound, category } = found;
            categoriesToExpand.add(category);
            newFavorites.push({
                id: sound.id,
                name: sound.name,
                url: sound.url,
                category: category,
                icon: sound.icon
            });
        }
    });
    favorites = newFavorites;
    persistFavorites();
    // Expand categories included in the preset for quick access
    expandedCategories = Array.from(categoriesToExpand);
    localStorage.setItem('soundboard-expanded', JSON.stringify(expandedCategories));
    render();
}

function openPresetModal() {
    const modal = document.getElementById('preset-modal');
    const grid = document.getElementById('preset-grid');
    if (grid) {
        const cards = Object.entries(presets).map(([name, cfg]) => `
            <div class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 flex flex-col cursor-pointer hover:border-emerald-500/70 transition-colors" onclick="applyPreset('${name}'); closePresetModal()">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl">${cfg.icon || 'üéõÔ∏è'}</span>
                    <div class="font-semibold">${name}</div>
                </div>
                <div class="text-sm text-slate-300 flex-1">${cfg.description || ''}</div>
                <div class="mt-3 text-right text-emerald-300 text-xs">Tap to apply</div>
            </div>
        `).join('');
        grid.innerHTML = cards;
    }
    modal.classList.remove('hidden');
}

function closePresetModal() {
    const modal = document.getElementById('preset-modal');
    modal.classList.add('hidden');
}

function expandAll() {
    expandedCategories = Object.keys(soundLibrary);
    localStorage.setItem('soundboard-expanded', JSON.stringify(expandedCategories));
    render();
}

function collapseAll() {
    expandedCategories = [];
    localStorage.setItem('soundboard-expanded', JSON.stringify(expandedCategories));
    render();
}

function sanitizeText(input) {
    if (typeof input !== 'string') return '';
    return input.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

function openSessionsModal() {
    renderSessionsModal();
    document.getElementById('sessions-modal').classList.remove('hidden');
}

function closeSessionsModal() {
    document.getElementById('sessions-modal').classList.add('hidden');
    const input = document.getElementById('session-name-input');
    if (input) input.value = '';
}

function renderSessionsModal() {
    const container = document.getElementById('sessions-list');
    if (!container) return;
    const rows = sessions.map(s => `
        <div class="flex items-center gap-2 py-2 border-b border-slate-800">
            <div class="flex-1 truncate ${s.id===currentSessionId?'text-emerald-300':''}">${sanitizeText(s.name)}</div>
            <button onclick="switchSession('${s.id}')" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">Switch</button>
            <button onclick="openRenameModal('${s.id}')" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">Rename</button>
            <button onclick="openConfirmClear('${s.id}')" class="px-2 py-1 text-xs rounded bg-amber-600 hover:bg-amber-700">Clear</button>
            <button onclick="openConfirmDelete('${s.id}')" class="px-2 py-1 text-xs rounded bg-red-600 hover:bg-red-700">Delete</button>
        </div>
    `).join('');
    container.innerHTML = rows || '<div class="text-slate-400">No sessions</div>';
}

let confirmState = { type: null, sessionId: null };
function openConfirm(title, message, type, sessionId) {
    confirmState = { type, sessionId };
    const t = document.getElementById('confirm-title');
    const m = document.getElementById('confirm-message');
    if (t) t.textContent = String(title || 'Confirm');
    if (m) m.textContent = String(message || 'Are you sure?');
    document.getElementById('confirm-modal').classList.remove('hidden');
}
function closeConfirmModal() {
    document.getElementById('confirm-modal').classList.add('hidden');
    confirmState = { type: null, sessionId: null };
}
function openConfirmClear(id) {
    const s = sessions.find(x => x.id===id);
    openConfirm('Clear Session', `Clear all favorites in "${s ? s.name : ''}"?`, 'clear', id);
}
function openConfirmDelete(id) {
    const s = sessions.find(x => x.id===id);
    openConfirm('Delete Session', `Delete session "${s ? s.name : ''}"? This cannot be undone.`, 'delete', id);
}
function confirmModalProceed() {
    if (confirmState.type === 'clear') {
        clearSession(confirmState.sessionId);
    } else if (confirmState.type === 'delete') {
        deleteSession(confirmState.sessionId);
    }
    closeConfirmModal();
}

function openInfoModal() { document.getElementById('info-modal').classList.remove('hidden'); }
function closeInfoModal() { document.getElementById('info-modal').classList.add('hidden'); }

function openImportModal() {
    const m = document.getElementById('import-modal');
    const err = document.getElementById('import-error');
    if (err) { err.classList.add('hidden'); err.textContent=''; }
    const f = document.getElementById('import-file');
    if (f) f.value = '';
    m.classList.remove('hidden');
}
function closeIOModal() {
    document.getElementById('import-modal').classList.add('hidden');
}

function showNotice(message) {
    const el = document.getElementById('notice-message');
    if (el) el.textContent = String(message || '');
    const m = document.getElementById('notice-modal');
    m.classList.remove('hidden');
}
function closeNotice() {
    document.getElementById('notice-modal').classList.add('hidden');
}

function createSessionFromModal() {
    const input = document.getElementById('session-name-input');
    const sanitized = sanitizeText((input?.value||'').trim()).slice(0,64);
    const err = document.getElementById('session-create-error');
    if (err) { err.classList.add('hidden'); err.textContent=''; }
    if (!sanitized) { if (err){err.textContent='Please enter a session name.'; err.classList.remove('hidden');} return; }
    if (sessions.some(s => s.name.toLowerCase() === sanitized.toLowerCase())) {
        if (err){err.textContent='Session name must be unique. Please choose another.'; err.classList.remove('hidden');}
        return;
    }
    const id = 's_' + Math.random().toString(36).slice(2,10);
    sessions.push({ id, name: sanitized });
    localStorage.setItem('soundboard-sessions', JSON.stringify(sessions));
    currentSessionId = id;
    localStorage.setItem('soundboard-currentSessionId', JSON.stringify(currentSessionId));
    favorites = [];
    persistFavorites();
    renderSessionsModal();
    // Immediately close modal so user can use the new session
    closeSessionsModal();
    render();
    input.value = '';
}

let renameTargetId = null;
function openRenameModal(id) {
    renameTargetId = id;
    const s = sessions.find(x=>x.id===id);
    const input = document.getElementById('rename-input');
    const err = document.getElementById('rename-error');
    if (err){err.textContent=''; err.classList.add('hidden');}
    if (input) input.value = s ? s.name : '';
    document.getElementById('rename-modal').classList.remove('hidden');
}
function closeRenameModal() {
    document.getElementById('rename-modal').classList.add('hidden');
    renameTargetId = null;
}
function saveRenameSession() {
    const s = sessions.find(x=>x.id===renameTargetId);
    if (!s) { closeRenameModal(); return; }
    const input = document.getElementById('rename-input');
    const err = document.getElementById('rename-error');
    const sanitized = sanitizeText((input?.value||'').trim()).slice(0,64);
    if (err){err.textContent=''; err.classList.add('hidden');}
    if (!sanitized) { if (err){err.textContent='Please enter a session name.'; err.classList.remove('hidden');} return; }
    if (sessions.some(x => x.id!==s.id && x.name.toLowerCase()===sanitized.toLowerCase())) {
        if (err){err.textContent='Session name must be unique. Please choose another.'; err.classList.remove('hidden');}
        return;
    }
    s.name = sanitized;
    localStorage.setItem('soundboard-sessions', JSON.stringify(sessions));
    renderSessionsModal();
    closeRenameModal();
    // Re-render to update header label if current session was renamed
    render();
}

function clearSession(id) {
    if (!sessions.find(s=>s.id===id)) return;
    localStorage.setItem(`soundboard-favorites-${id}`, '[]');
    if (id===currentSessionId) { favorites = []; render(); }
    renderSessionsModal();
}

function deleteSession(id) {
    if (sessions.length<=1) { showNotice('Cannot delete the last session.'); return; }
    sessions = sessions.filter(s=>s.id!==id);
    localStorage.setItem('soundboard-sessions', JSON.stringify(sessions));
    localStorage.removeItem(`soundboard-favorites-${id}`);
    if (currentSessionId===id) {
        currentSessionId = sessions[0].id;
        localStorage.setItem('soundboard-currentSessionId', JSON.stringify(currentSessionId));
        favorites = loadFavorites();
        render();
    }
    renderSessionsModal();
}

function sessionsPopulateSelect() {
    const sel = document.getElementById('session-select');
    if (!sel) return;
    sel.innerHTML = sessions.map(s => `<option value="${s.id}" ${s.id===currentSessionId?'selected':''}>${sanitizeText(s.name)}</option>`).join('');
}

function switchSession(sessionId) {
    if (!sessions.find(s => s.id === sessionId)) return;
    currentSessionId = sessionId;
    localStorage.setItem('soundboard-currentSessionId', JSON.stringify(currentSessionId));
    favorites = loadFavorites();
    render();
    const sm = document.getElementById('sessions-modal');
    if (sm && !sm.classList.contains('hidden')) closeSessionsModal();
}

function newSessionPrompt() {
    const name = prompt('New session name:') || '';
    const sanitized = sanitizeText(name.trim()).slice(0, 64);
    if (!sanitized) return;
    const id = 's_' + Math.random().toString(36).slice(2, 10);
    sessions.push({ id, name: sanitized });
    localStorage.setItem('soundboard-sessions', JSON.stringify(sessions));
    currentSessionId = id;
    localStorage.setItem('soundboard-currentSessionId', JSON.stringify(currentSessionId));
    favorites = [];
    persistFavorites();
    sessionsPopulateSelect();
    render();
}

function renameSessionPrompt() {
    const cur = sessions.find(s => s.id === currentSessionId);
    if (!cur) return;
    const name = prompt('Rename session:', cur.name) || '';
    const sanitized = sanitizeText(name.trim()).slice(0, 64);
    if (!sanitized) return;
    cur.name = sanitized;
    localStorage.setItem('soundboard-sessions', JSON.stringify(sessions));
    sessionsPopulateSelect();
}

function clearSessionConfirm() {
    if (!confirm('Clear all favorites in this session?')) return;
    favorites = [];
    persistFavorites();
    render();
}

function deleteSessionConfirm() {
    if (!confirm('Delete this session and its data?')) return;
    if (sessions.length <= 1) { alert('Cannot delete the last session.'); return; }
    localStorage.removeItem(getFavoritesKey());
    sessions = sessions.filter(s => s.id !== currentSessionId);
    localStorage.setItem('soundboard-sessions', JSON.stringify(sessions));
    currentSessionId = sessions[0].id;
    localStorage.setItem('soundboard-currentSessionId', JSON.stringify(currentSessionId));
    favorites = loadFavorites();
    sessionsPopulateSelect();
    render();
}

function exportFavorites() {
    const names = (favorites||[]).map(f => f.name).filter(n => !!n);
    const unique = Array.from(new Set(names));
    const data = { version: 2, names: unique };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const sess = sessions.find(s => s.id === currentSessionId);
    a.download = `soundboard_${(sess?.name||'session').replace(/\s+/g,'_').toLowerCase()}.json`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
}

function importFavoritesFromInput() {
    const file = document.getElementById('import-file')?.files?.[0];
    const err = document.getElementById('import-error');
    if (err) { err.classList.add('hidden'); err.textContent=''; }
    if (!file) { if (err){err.textContent='Please choose a JSON file.'; err.classList.remove('hidden');} return; }
    const reader = new FileReader();
    reader.onload = () => {
        try {
            const obj = JSON.parse(String(reader.result || '{}'));
            // Support v2 (names) and v1 (favorites objects), but only use names
            let names = Array.isArray(obj?.names) ? obj.names : Array.isArray(obj?.favorites) ? obj.favorites.map(x => x?.name) : [];
            names = names.map(n => sanitizeText(String(n||'').slice(0,128))).filter(n => !!n);
            const seen = new Set();
            const unique = names.filter(n => { const k=n.toLowerCase(); if (seen.has(k)) return false; seen.add(k); return true; });
            // Map names to sounds in the library
            const resolved = unique.map(n => findSoundByName(n)).filter(Boolean);
            const missing = unique.filter(n => !findSoundByName(n));
            favorites = resolved.map(({ sound, category }) => ({ id: sound.id, name: sound.name, url: sound.url, category, icon: sound.icon }));
            persistFavorites();
            render();
            closeIOModal();
            if (missing.length) {
                showNotice(`Imported with ${missing.length} not found: ${missing.slice(0,5).join(', ')}${missing.length>5 ? '‚Ä¶' : ''}`);
            } else {
                showNotice('Favorites imported.');
            }
        } catch (e) {
            if (err){err.textContent='Incorrect file format. Export a sample to see the expected JSON.'; err.classList.remove('hidden');}
        }
    };
    reader.onerror = () => { if (err){err.textContent='Failed to read file.'; err.classList.remove('hidden');} };
    reader.readAsText(file);
}

function favoriteCategory(category) {
    const sounds = soundLibrary[category];
    const soundIds = sounds.map(s => s.id);
    const allFavorited = soundIds.every(id => isFavorite(id));
    if (allFavorited) {
        // Unfavorite all in this category
        favorites = favorites.filter(f => f.category !== category);
    } else {
        // Favorite all missing in this category
        sounds.forEach(sound => {
            if (!isFavorite(sound.id)) {
                favorites.push({ 
                    id: sound.id, 
                    name: sound.name, 
                    url: sound.url, 
                    category: category, 
                    icon: sound.icon 
                });
            }
        });
    }
    persistFavorites();
    render();
}

        // Initialize Audio Element
        function getAudioElement(soundId, url, loop = false) {
    if (!audioElements[soundId]) {
        const audio = new Audio(url);
        audio.loop = loop;
        audio.addEventListener('ended', () => {
            if (!audio.loop) {
                stopSound(soundId);
            }
        });
        let lastRenderTime = 0;
audio.addEventListener('timeupdate', () => {
    if (activeSounds[soundId]) {
        activeSounds[soundId].currentTime = audio.currentTime;
        activeSounds[soundId].duration = audio.duration;
        // Only render once per second to reduce flickering
        const now = Date.now();
        if (now - lastRenderTime > 1000) {
            lastRenderTime = now;
            render();
        }
    }
});
        audio.addEventListener('loadedmetadata', () => {
            if (activeSounds[soundId]) {
                activeSounds[soundId].duration = audio.duration;
                render();
            }
        });
        audioElements[soundId] = audio;
    }
    return audioElements[soundId];
}

        // Play/Pause Sound
        function playSound(soundId, soundName, url, category, icon) {
    // Check if sound is already in activeSounds (paused or stopped)
    const sound = activeSounds[soundId];
    const loop = sound ? sound.loop : false;
    const audio = getAudioElement(soundId, url, loop);
    
    if (sound && sound.isPlaying) {
        audio.pause();
        activeSounds[soundId].isPlaying = false;
    } else {
        audio.play();
        if (!activeSounds[soundId]) {
            // First time playing this sound
            activeSounds[soundId] = {
                name: soundName,
                url: url,
                category: category,
                icon: icon,
                isPlaying: true,
                loop: false,
                volume: 0.7,
                smartMix: false,
                duckApplied: false,
                originalVolume: undefined
            };
            audio.volume = 0.7;
        } else {
            // Resuming a paused sound
            activeSounds[soundId].isPlaying = true;
        }
    }
    updateDucking();
    render();
}

function setLoopBeforePlay(soundId, soundName, url, category, icon) {
    if (!activeSounds[soundId]) {
        // Sound hasn't been played yet, add it to activeSounds with loop enabled
        activeSounds[soundId] = {
            name: soundName,
            url: url,
            category: category,
            icon: icon,
            isPlaying: false,
            loop: true,
            volume: 0.7
        };
        // Pre-initialize audio with loop
        const audio = getAudioElement(soundId, url, true);
        audio.volume = 0.7;
    } else {
        // Sound already exists, just toggle loop
        toggleLoop(soundId);
    }
    render();
}

function setSmartMixBeforePlay(soundId, soundName, url, category, icon) {
    if (!activeSounds[soundId]) {
        activeSounds[soundId] = {
            name: soundName,
            url: url,
            category: category,
            icon: icon,
            isPlaying: false,
            loop: false,
            volume: 0.7,
            smartMix: true,
            duckApplied: false,
            originalVolume: undefined
        };
        const audio = getAudioElement(soundId, url, false);
        audio.volume = 0.7;
    } else {
        toggleSmartMix(soundId);
    }
    updateDucking();
    render();
}

        // Stop Sound
        function stopSound(soundId) {
            const audio = audioElements[soundId];
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            delete activeSounds[soundId];
            updateDucking();
            render();
        }

        // Toggle Loop
        function toggleLoop(soundId) {
            const audio = audioElements[soundId];
            const newLoop = !activeSounds[soundId].loop;
            if (audio) {
                audio.loop = newLoop;
            }
            activeSounds[soundId].loop = newLoop;
            render();
        }

        // Set Volume
        function setVolume(soundId, volume) {
            const audio = audioElements[soundId];
            if (audio) {
                audio.volume = volume;
            }
            activeSounds[soundId].volume = volume;
            //render();
        }

        function toggleSmartMix(soundId) {
            if (!activeSounds[soundId]) return;
            activeSounds[soundId].smartMix = !activeSounds[soundId].smartMix;
            updateDucking();
            render();
        }

        function updateDucking() {
            // Find if any priority (smartMix) sound is currently playing
            const priorityIds = Object.entries(activeSounds)
                .filter(([_, s]) => s.isPlaying && s.smartMix)
                .map(([id]) => id);
            const hasPriority = priorityIds.length > 0;
            Object.entries(activeSounds).forEach(([id, s]) => {
                const audio = audioElements[id];
                if (!audio) return;
                if (hasPriority && !s.smartMix && s.isPlaying) {
                    if (!s.duckApplied) {
                        s.originalVolume = s.volume;
                        const newVol = Math.max(0, Math.min(1, s.volume * DUCK_FACTOR));
                        s.volume = newVol;
                        audio.volume = newVol;
                        s.duckApplied = true;
                    }
                } else if (s.duckApplied) {
                    const restore = s.originalVolume != null ? s.originalVolume : s.volume;
                    s.volume = restore;
                    audio.volume = restore;
                    s.originalVolume = undefined;
                    s.duckApplied = false;
                }
            });
        }

        function clearAllActiveSounds() {
            Object.keys(activeSounds).forEach(soundId => {
                const audio = audioElements[soundId];
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
                delete activeSounds[soundId];
            });
            render();
        }

        function toggleActiveBarSize() {
            activeBarExpanded = !activeBarExpanded;
            localStorage.setItem('soundboard-activeBarExpanded', JSON.stringify(activeBarExpanded));
            render();
        }

        // Toggle Favorite
        function toggleFavorite(soundId, soundName, url, category, icon) {
            const index = favorites.findIndex(f => f.id === soundId);
            if (index >= 0) {
                favorites.splice(index, 1);
            } else {
                favorites.push({ id: soundId, name: soundName, url: url, category: category, icon: icon });
            }
    persistFavorites();
            render();
        }

        // Clear All Favorites
        function clearAllFavorites() {
            favorites = [];
            persistFavorites();
            render();
        }

        // Check if Favorite
        function isFavorite(soundId) {
            return favorites.some(f => f.id === soundId);
        }

        function getTags(soundName, category) {
            const tags = [];
            const name = (soundName || '').toLowerCase();
            const cat = (category || '').toLowerCase();
            if (/ambience|ambient|hum|stream|waves|wind|crowd/.test(name) || /forest|dungeon|ocean|city|tavern|ambience/.test(cat)) tags.push('ambient');
            if (/scream|impact|slam|clap|gong|glass|break|trap|door/.test(name)) tags.push('event');
            if (/loop|ambience|hum|rain|waves|wind|music/.test(name)) tags.push('loop');
            if (/whisper|breath|quiet|soft/.test(name)) tags.push('subtle');
            if (/dragon|zombie|ghost|skeleton|troll|goblin|spider/.test(name) || /creatures/.test(cat)) tags.push('creature');
            return tags;
        }

        function getTagsDisplay(soundName, category) {
            return getTags(soundName, category).join(', ');
        }

        // Switch Tab
        function switchTab(category) {
            activeTab = category;
    localStorage.setItem('soundboard-activeTab', JSON.stringify(activeTab));
            render();
        }

	// Format time in MM:SS
function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function toggleLightMode() {
    lightMode = !lightMode;
    localStorage.setItem('soundboard-lightMode', JSON.stringify(lightMode));
    render();
}

        // Render UI
        function render() {
            
// Render Expandable Categories
const categoriesHtml = Object.keys(soundLibrary).map(category => {
    const isExpanded = expandedCategories.includes(category);
    const sounds = soundLibrary[category];
    const allFavorited = sounds.every(s => isFavorite(s.id));
    
    return `
        <div class="mb-4 bg-slate-800/30 backdrop-blur rounded-lg border border-slate-700 overflow-hidden">
            <div class="flex items-center">
    <button onclick="toggleCategory('${category}')" 
        class="flex-1 px-4 py-4 flex items-center justify-between hover:bg-slate-700/50 transition-colors">
        <div class="flex items-center gap-3">
            <span class="text-2xl">${categoryIcons[category]}</span>
            <span class="font-semibold text-lg">${category}</span>
            <span class="text-sm text-slate-400">(${sounds.length})</span>
        </div>
        <span class="text-2xl transform transition-transform ${isExpanded ? 'rotate-180' : ''}">‚ñº</span>
    </button>
    <button onclick="event.stopPropagation(); favoriteCategory('${category}')" 
        class="px-4 py-4 hover:bg-slate-700/50 transition-colors border-l border-slate-700" 
        title="${allFavorited ? 'Unfavorite all in this category' : 'Favorite all in this category'}">
        <span class="text-xl">${allFavorited ? '‚≠ê' : '‚òÜ'}</span>
    </button>
</div>
            
            ${isExpanded ? `
                <div class="p-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 border-t border-slate-700">
                    ${sounds.map(sound => {
                        const isActive = activeSounds[sound.id];
                        const favorite = isFavorite(sound.id);
                        return `
                            <div id="card-${sound.id}" class="relative bg-slate-800/50 rounded-lg p-3 border border-slate-700 hover:border-purple-500 transition-all">
                                <button onclick="toggleFavorite('${sound.id}', '${sound.name}', '${sound.url}', '${category}', '${sound.icon}')" 
                                    class="absolute top-1 right-1 p-1 hover:bg-slate-700 rounded transition-colors z-10">
                                    <span class="block text-sm">${favorite ? '‚≠ê' : '‚òÜ'}</span>
                                </button>
                                <div class="flex flex-col items-center mb-2 pt-4">
                                    <span class="text-3xl mb-1">${sound.icon}</span>
                                    <h3 class="font-medium text-center text-xs leading-tight">${sound.name}</h3>
                                    ${isActive?.isPlaying ? '<div class="mt-1 flex gap-1"><span class="w-1.5 h-2 bg-green-400 animate-pulse"></span><span class="w-1.5 h-3 bg-green-300 animate-pulse"></span><span class="w-1.5 h-2 bg-green-400 animate-pulse"></span></div>' : ''}
                                    <div class="mt-1 flex flex-wrap justify-center gap-1">
                                        ${getTags(sound.name, category).map(t => `<span class=\"px-1.5 py-0.5 rounded-full text-[10px] bg-slate-700 text-slate-300\">${t}</span>`).join('')}
                                    </div>
                                </div>
                                <button onclick="playSound('${sound.id}', '${sound.name}', '${sound.url}', '${category}', '${sound.icon}')" 
                                    class="w-full px-2 py-1.5 rounded text-xs font-medium transition-all flex items-center justify-center gap-1 ${
                                        isActive?.isPlaying 
                                            ? 'bg-green-600 hover:bg-green-700' 
                                            : 'bg-purple-600 hover:bg-purple-700'
                                    }">
                                    ${isActive?.isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                                </button>
                                <button onclick="${isActive ? `toggleLoop('${sound.id}')` : `setLoopBeforePlay('${sound.id}', '${sound.name}', '${sound.url}', '${category}', '${sound.icon}')`}" 
                                    class="w-full mt-1 px-2 py-1 rounded text-xs font-medium transition-all flex items-center justify-center gap-1 ${
                                        isActive?.loop 
                                            ? 'bg-blue-600 hover:bg-blue-700' 
                                            : 'bg-slate-700 hover:bg-slate-600'
                                    }">
                                    ${isActive?.loop ? 'üîÅ Looping' : '‚Üª Loop Off'}
                                </button>
                                <button onclick="${isActive ? `toggleSmartMix('${sound.id}')` : `setSmartMixBeforePlay('${sound.id}', '${sound.name}', '${sound.url}', '${category}', '${sound.icon}')`}" 
                                    class="w-full mt-1 px-2 py-1 rounded text-xs font-medium transition-all flex items-center justify-center gap-1 ${
                                        isActive?.smartMix 
                                            ? 'bg-pink-600 hover:bg-pink-700' 
                                            : 'bg-slate-700 hover:bg-slate-600'
                                    }">
                                    ${isActive?.smartMix ? 'üéöÔ∏è Priority' : 'üéöÔ∏è Normal'}
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : ''}
        </div>
    `;
}).join('');

document.getElementById('categories-container').innerHTML = categoriesHtml;
            // Update active session label
            const sessLbl = document.getElementById('active-session-label');
            if (sessLbl) {
                const sess = sessions.find(s => s.id === currentSessionId);
                sessLbl.textContent = `Session: ${sess ? sess.name : 'Default'}`;
            }
            // Apply light mode
            const bodyEl = document.body;
            if (lightMode) {
                bodyEl.classList.add('light-mode');
            } else {
                bodyEl.classList.remove('light-mode');
            }

            // Render Favorites
            const favHtml = favorites.map(sound => {
                const isActive = activeSounds[sound.id]?.isPlaying;
                return `
                    <div class="relative">
                        <button onclick="playSound('${sound.id}', '${sound.name}', '${sound.url}', '${sound.category}', '${sound.icon}')" 
                            class="w-full px-3 py-4 rounded-lg font-medium transition-all flex flex-col items-center gap-2 ${
                                isActive 
                                    ? 'bg-gradient-to-r from-green-600 to-emerald-600 shadow-lg shadow-green-500/50' 
                                    : 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500'
                            }">
                            <span class="text-2xl">${sound.icon}</span>
                            <span class="text-sm text-center">${sound.name}</span>
                        </button>
                        <button onclick="toggleFavorite('${sound.id}', '${sound.name}', '${sound.url}', '${sound.category}', '${sound.icon}')" 
                            class="absolute -top-2 -right-2 p-1 bg-slate-700 hover:bg-slate-600 rounded-full transition-colors">
                            <span class="w-4 h-4 block">${icons.x}</span>
                        </button>
                    </div>
                `;
            }).join('');
            document.getElementById('favorites-grid').innerHTML = favHtml;

            // Sound Grid removed

            // Render Active Sounds (this should already be there at the end of render function)
const playingEntries = Object.entries(activeSounds);
const activeSoundsCount = playingEntries.length;
const activeBar = document.getElementById('active-sounds-bar');
if (activeSoundsCount > 0) {
    activeBar.classList.remove('hidden');
    document.getElementById('active-count').textContent = activeSoundsCount;
    // Adjust size
    const gridEl = document.getElementById('active-sounds-grid');
    const sizeBtn = document.getElementById('activebar-size-btn');
    if (gridEl) {
        if (activeBarExpanded) {
            gridEl.style.maxHeight = '50vh';
        } else {
            gridEl.style.maxHeight = '12rem';
        }
    }
    if (sizeBtn) {
        sizeBtn.textContent = activeBarExpanded ? 'Collapse' : 'Expand';
    }
    const activeHtml = playingEntries.map(([soundId, sound]) => `
        <div class="bg-slate-800 rounded-lg p-3 flex items-center gap-3">
            <span class="text-xl flex-shrink-0">${sound.icon}</span>
            <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-1">
                    <div class="font-medium text-sm truncate">${sound.name}</div>
                    <div class="time-display ml-2 flex-shrink-0">
                        ${formatTime(sound.currentTime || 0)} / ${formatTime(sound.duration || 0)}
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 text-purple-400 flex-shrink-0">${icons.volume}</span>
                    <input type="range" min="0" max="1" step="0.01" value="${sound.volume}" 
                        oninput="setVolume('${soundId}', parseFloat(this.value)); event.stopPropagation();"
                        onmouseup="render()"
                        class="flex-1 h-1 rounded-lg appearance-none cursor-pointer"
                        style="background: linear-gradient(to right, rgb(168, 85, 247) 0%, rgb(168, 85, 247) ${sound.volume * 100}%, rgb(51, 65, 85) ${sound.volume * 100}%, rgb(51, 65, 85) 100%)" />
                    <span class="text-xs text-slate-400 w-8 flex-shrink-0">${Math.round(sound.volume * 100)}%</span>
                </div>
            </div>
            <div class="flex gap-1 flex-shrink-0">
                <button onclick="toggleSmartMix('${soundId}')" class="px-2 py-1 text-[10px] rounded ${sound.smartMix ? 'bg-pink-600 hover:bg-pink-700 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-200'}" title="Toggle priority smart mix">${sound.smartMix ? 'Priority' : 'Normal'}</button>
                <button onclick="toggleLoop('${soundId}')" 
                    class="p-2 rounded transition-colors ${sound.loop ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-700 hover:bg-slate-600'}" 
                    title="${sound.loop ? 'Looping' : 'Play once'}">
                    <span class="w-4 h-4 block">${sound.loop ? icons.repeat : icons.repeat1}</span>
                </button>
                <button onclick="playSound('${soundId}', '${sound.name}', '${sound.url}', '${sound.category}', '${sound.icon}')" 
                    class="p-2 bg-slate-700 hover:bg-slate-600 rounded transition-colors">
                    <span class="w-4 h-4 block">${sound.isPlaying ? icons.pause : icons.play}</span>
                </button>
                <button onclick="stopSound('${soundId}')" 
                    class="p-2 bg-red-600 hover:bg-red-700 rounded transition-colors">
                    <span class="w-4 h-4 block">${icons.square}</span>
                </button>
            </div>
        </div>
    `).join('');
    document.getElementById('active-sounds-grid').innerHTML = activeHtml;
} else {
    activeBar.classList.add('hidden');
}
        }

        // Initial Render
        render();
    </script>
</body>
</html>
